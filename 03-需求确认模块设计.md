# éœ€æ±‚ç¡®è®¤æ¨¡å—è®¾è®¡

## æ¨¡å—æ¦‚è¿°

éœ€æ±‚ç¡®è®¤æ¨¡å—æ‰¿æ‹…åŒé‡èŒè´£ï¼š
1. **ç”¨æˆ·ç¡®è®¤ç•Œé¢**ï¼šå°†æ™ºèƒ½é—®ç­”çš„å¤æ‚è¾“å‡ºè½¬æ¢ä¸ºç”¨æˆ·å‹å¥½çš„éœ€æ±‚æ€»ç»“ï¼Œä¾›ç”¨æˆ·ç¡®è®¤å’Œè°ƒæ•´
2. **04æ¨¡å—è¾“å…¥å‡†å¤‡**ï¼šåŸºäºç”¨æˆ·ç¡®è®¤ç»“æœå’ŒåŸå§‹æ•°æ®ï¼Œç”ŸæˆPRDæ¨¡å—éœ€è¦çš„è¯¦ç»†å®Œæ•´è¾“å…¥

## æ ¸å¿ƒè®¾è®¡åŸåˆ™

### âœ… **åŒé‡è¾“å‡ºåˆ†ç¦»**
- **ç”¨æˆ·ç•Œé¢**ï¼šç®€æ´æ˜äº†ï¼Œé¿å…æŠ€æœ¯æœ¯è¯­ï¼Œä¸“æ³¨æ ¸å¿ƒåŠŸèƒ½ç¡®è®¤
- **04æ¨¡å—è¾“å…¥**ï¼šè¯¦ç»†å®Œæ•´ï¼ŒåŒ…å«PRDç”Ÿæˆæ‰€éœ€çš„æ‰€æœ‰æŠ€æœ¯ä¿¡æ¯

### âœ… **ç”¨æˆ·å‹å¥½çš„ç¡®è®¤ä½“éªŒ**
- æ¸…æ™°å±•ç¤ºç†è§£ç»“æœï¼Œè¯­è¨€ç®€æ´æ˜“æ‡‚
- æ”¯æŒå¿«é€Ÿä¿®æ­£å’Œè°ƒæ•´åŠŸèƒ½
- ä¸€é”®ç¡®è®¤æˆ–é‡æ–°æ¾„æ¸…éœ€æ±‚

### âœ… **æ‰¿æ‹…æ•°æ®è½¬æ¢èŒè´£**
- ä¸º04æ¨¡å—å‡è½»æ•°æ®å¤„ç†å‹åŠ›
- å°†ç”¨æˆ·ç¡®è®¤ç»“æœæ‰©å±•ä¸ºå®Œæ•´çš„æŠ€æœ¯è§„æ ¼
- ç¡®ä¿04æ¨¡å—ä¸“æ³¨PRDç”Ÿæˆå’Œæµå¼è¾“å‡º

## ğŸ”„ å¤„ç†æµç¨‹

### 1. æ¥æ”¶æ™ºèƒ½é—®ç­”ç»“æœ

```typescript
interface SmartQuestioningResult {
  // æ ¸å¿ƒæå–ä¿¡æ¯
  extractedInfo: ExtractedInfo;

  // é—®ç­”ä¼šè¯æ•°æ®
  questioningSession: {
    questions: Question[];
    answers: Answer[];
    totalRounds: number;
    duration: number;
    completionReason: string;
  };

  // ä¿¡æ¯å®Œæ•´æ€§è¯„ä¼°
  completeness: {
    critical: number;      // å…³é”®ä¿¡æ¯å®Œæ•´åº¦ (0-1)
    important: number;     // é‡è¦ä¿¡æ¯å®Œæ•´åº¦ (0-1)
    optional: number;      // å¯é€‰ä¿¡æ¯å®Œæ•´åº¦ (0-1)
    overall: number;       // æ•´ä½“å®Œæ•´åº¦ (0-1)
  };

  // ç”¨æˆ·è¾“å…¥åŸå§‹æ•°æ®
  userInputResult: UserInputResult;

  // è´¨é‡éªŒè¯
  validation: {
    extractionConfidence: number;  // ä¿¡æ¯æå–ç½®ä¿¡åº¦
    questioningQuality: number;    // é—®ç­”è´¨é‡è¯„åˆ†
    readyForConfirmation: boolean; // æ˜¯å¦å‡†å¤‡å¥½è¿›å…¥ç¡®è®¤é˜¶æ®µ
  };
}
```

### 2. ç”Ÿæˆéœ€æ±‚ç†è§£æ€»ç»“

```typescript
interface RequirementSummary {
  projectName: string;
  coreGoal: string;
  targetUsers: string;
  mainFeatures: Feature[];
  technicalLevel: 'simple' | 'moderate' | 'complex';
  keyConstraints?: string[];
  userScope: string;
}

interface Feature {
  name: string;
  description: string;
  essential: boolean;
  source: 'user_input' | 'ai_inferred' | 'user_confirmed';
}
```

### 3. éœ€æ±‚æ€»ç»“ç”Ÿæˆå™¨

```typescript
class RequirementSummaryGenerator {
  async generateSummary(
    extractedInfo: ExtractedInfo,
    answers: Answer[],
    userInputResult: UserInputResult
  ): Promise<RequirementSummary> {
    const prompt = `
      åŸºäºç”¨æˆ·éœ€æ±‚å’Œé—®ç­”ç»“æœï¼Œç”Ÿæˆå‡†ç¡®ç®€æ´çš„éœ€æ±‚ç†è§£æ€»ç»“ï¼š

      åŸå§‹éœ€æ±‚ï¼š${userInputResult.originalInput.text}
      æå–ä¿¡æ¯ï¼š${JSON.stringify(extractedInfo)}
      é—®ç­”ç»“æœï¼š${JSON.stringify(answers)}

      è¯·ç”ŸæˆJSONæ ¼å¼çš„éœ€æ±‚æ€»ç»“ï¼š
      {
        "projectName": "é¡¹ç›®åç§°ï¼ˆç®€æ´æœ‰æ„ä¹‰ï¼‰",
        "coreGoal": "æ ¸å¿ƒç›®æ ‡ï¼ˆä¸€å¥è¯ï¼Œ20å­—å†…ï¼Œç”¨ç”¨æˆ·è¯­è¨€è¡¨è¾¾ï¼‰",
        "targetUsers": "ç›®æ ‡ç”¨æˆ·ç¾¤ä½“",
        "mainFeatures": [
          {
            "name": "åŠŸèƒ½åç§°",
            "description": "åŠŸèƒ½è¯´æ˜ï¼ˆç”¨æˆ·èƒ½ç†è§£çš„è¯­è¨€ï¼‰",
            "essential": true/false
          }
        ],
        "technicalLevel": "simple/moderate/complex",
        "keyConstraints": ["å…³é”®çº¦æŸæ¡ä»¶"],
        "userScope": "personal/small_team/public"
      }

      è¦æ±‚ï¼š
      1. åŠŸèƒ½æ•°é‡æ§åˆ¶åœ¨3-5ä¸ªï¼Œé¿å…è¿‡åº¦å·¥ç¨‹åŒ–
      2. è¯­è¨€ç®€æ´æ˜äº†ï¼Œé¿å…æŠ€æœ¯æœ¯è¯­
      3. çªå‡ºæ ¸å¿ƒåŠŸèƒ½ï¼Œæ¬¡è¦åŠŸèƒ½æ ‡è®°ä¸ºéå¿…éœ€
      4. åŸºäºç”¨æˆ·çš„å®é™…è¡¨è¾¾ï¼Œä¸è¦è¿‡åº¦æ¨æ–­
    `

    return await claudeAPI.generateStructuredSummary(prompt)
  }

  validateSummaryQuality(summary: RequirementSummary): ValidationResult {
    const issues: string[] = []
    let score = 1.0

    // åŠŸèƒ½è¿‡å¤šæ£€æŸ¥
    if (summary.mainFeatures.length > 6) {
      issues.push('åŠŸèƒ½è¾ƒå¤šï¼Œå»ºè®®ç®€åŒ–ä¸ºæ ¸å¿ƒåŠŸèƒ½')
      score -= 0.2
    }

    // å¤æ‚åº¦ä¸åŠŸèƒ½ä¸åŒ¹é…æ£€æŸ¥
    const essentialCount = summary.mainFeatures.filter(f => f.essential).length
    if (summary.technicalLevel === 'simple' && essentialCount > 4) {
      issues.push('åŠŸèƒ½æ•°é‡ä¸ç®€å•å¤æ‚åº¦ä¸åŒ¹é…')
      score -= 0.3
    }

    // ç›®æ ‡æ¸…æ™°åº¦æ£€æŸ¥
    if (summary.coreGoal.length > 30 || summary.coreGoal.includes('ç³»ç»Ÿ') || summary.coreGoal.includes('å¹³å°')) {
      issues.push('æ ¸å¿ƒç›®æ ‡è¡¨è¿°å¯ä»¥æ›´å…·ä½“')
      score -= 0.1
    }

    return {
      isValid: score >= 0.7,
      score,
      issues,
      suggestions: this.generateImprovementSuggestions(summary, issues)
    }
  }

  private generateImprovementSuggestions(summary: RequirementSummary, issues: string[]): string[] {
    const suggestions: string[] = []

    if (issues.includes('åŠŸèƒ½è¾ƒå¤šï¼Œå»ºè®®ç®€åŒ–ä¸ºæ ¸å¿ƒåŠŸèƒ½')) {
      suggestions.push('è€ƒè™‘å°†æ¬¡è¦åŠŸèƒ½æ ‡è®°ä¸ºå¯é€‰ï¼Œä¸“æ³¨æ ¸å¿ƒä»·å€¼')
    }

    if (issues.includes('æ ¸å¿ƒç›®æ ‡è¡¨è¿°å¯ä»¥æ›´å…·ä½“')) {
      suggestions.push('ç”¨æ›´å…·ä½“çš„åŠ¨è¯æè¿°ç”¨æˆ·æƒ³è¦è¾¾æˆçš„ç›®æ ‡')
    }

    return suggestions
  }
}
```

## ğŸ¨ ç¡®è®¤ç•Œé¢è®¾è®¡

### éœ€æ±‚ç¡®è®¤ç•Œé¢ç»„ä»¶

```tsx
const RequirementConfirmationInterface = ({
  summary,
  onConfirm,
  onAdjust,
  onRestart
}: {
  summary: RequirementSummary,
  onConfirm: () => void,
  onAdjust: (adjustments: AdjustmentRequest[]) => void,
  onRestart: () => void
}) => {
  const [selectedAdjustments, setSelectedAdjustments] = useState<AdjustmentRequest[]>([])

  return (
    <div className="requirement-confirmation-interface">
      <div className="confirmation-header">
        <h2>ğŸ¯ è¯·ç¡®è®¤æˆ‘ä»¬å¯¹æ‚¨éœ€æ±‚çš„ç†è§£</h2>
        <p className="sub-text">ç¡®è®¤åæˆ‘ä»¬å°†ç”Ÿæˆè¯¦ç»†çš„äº§å“éœ€æ±‚æ–‡æ¡£</p>
      </div>

      <div className="summary-card">
        <div className="summary-section">
          <div className="goal-section">
            <h3>æ ¸å¿ƒç›®æ ‡</h3>
            <p className="goal-text">{summary.coreGoal}</p>
            <button
              className="adjust-button"
              onClick={() => toggleAdjustment('goal', summary.coreGoal)}
            >
              ä¿®æ”¹
            </button>
          </div>

          <div className="users-section">
            <h3>ç›®æ ‡ç”¨æˆ·</h3>
            <p>{summary.targetUsers}</p>
            <button
              className="adjust-button"
              onClick={() => toggleAdjustment('users', summary.targetUsers)}
            >
              ä¿®æ”¹
            </button>
          </div>

          <div className="complexity-section">
            <h3>æŠ€æœ¯å¤æ‚åº¦</h3>
            <span className={`complexity-badge ${summary.technicalLevel}`}>
              {getComplexityLabel(summary.technicalLevel)}
            </span>
          </div>
        </div>

        <div className="features-section">
          <h3>ä¸»è¦åŠŸèƒ½</h3>
          {summary.mainFeatures.map((feature, index) => (
            <div key={index} className="feature-item">
              <div className="feature-content">
                <span className="feature-name">{feature.name}</span>
                <span className="feature-desc">{feature.description}</span>
                {feature.essential && <span className="essential-badge">æ ¸å¿ƒ</span>}
              </div>
              <div className="feature-actions">
                <button onClick={() => toggleAdjustment('modify_feature', feature, index)}>
                  ä¿®æ”¹
                </button>
                <button onClick={() => toggleAdjustment('remove_feature', feature, index)}>
                  åˆ é™¤
                </button>
              </div>
            </div>
          ))}

          <button
            className="add-feature-button"
            onClick={() => toggleAdjustment('add_feature')}
          >
            + æ·»åŠ åŠŸèƒ½
          </button>
        </div>
      </div>

      {/* è°ƒæ•´é¢æ¿ */}
      {selectedAdjustments.length > 0 && (
        <div className="adjustment-panel">
          <h4>éœ€è¦è°ƒæ•´çš„å†…å®¹</h4>
          {selectedAdjustments.map((adj, index) => (
            <AdjustmentItem
              key={index}
              adjustment={adj}
              onUpdate={(updated) => updateAdjustment(index, updated)}
              onRemove={() => removeAdjustment(index)}
            />
          ))}
          <div className="adjustment-actions">
            <button onClick={() => onAdjust(selectedAdjustments)}>
              åº”ç”¨è°ƒæ•´
            </button>
            <button onClick={() => setSelectedAdjustments([])}>
              å–æ¶ˆ
            </button>
          </div>
        </div>
      )}

      <div className="confirmation-actions">
        <button onClick={onConfirm} className="primary-confirm-btn">
          âœ… ç†è§£å‡†ç¡®ï¼Œç”ŸæˆPRD
        </button>
        <button onClick={() => setShowAdjustmentHelp(true)} className="secondary-adjust-btn">
          ğŸ”§ éœ€è¦å¾®è°ƒ
        </button>
        <button onClick={onRestart} className="restart-btn">
          ğŸ”„ é‡æ–°å¼€å§‹é—®ç­”
        </button>
      </div>
    </div>
  )
}

// è°ƒæ•´é¡¹ç»„ä»¶
const AdjustmentItem = ({ adjustment, onUpdate, onRemove }) => {
  const [editValue, setEditValue] = useState(adjustment.currentValue)

  return (
    <div className="adjustment-item">
      <div className="adjustment-header">
        <span className="adjustment-type">{getAdjustmentTypeLabel(adjustment.type)}</span>
        <button onClick={onRemove} className="remove-adjustment">Ã—</button>
      </div>

      <div className="adjustment-content">
        {adjustment.type === 'modify_text' && (
          <textarea
            value={editValue}
            onChange={(e) => setEditValue(e.target.value)}
            placeholder="è¾“å…¥ä¿®æ”¹åçš„å†…å®¹"
          />
        )}

        {adjustment.type === 'add_feature' && (
          <div className="add-feature-form">
            <input
              placeholder="åŠŸèƒ½åç§°"
              onChange={(e) => onUpdate({...adjustment, name: e.target.value})}
            />
            <textarea
              placeholder="åŠŸèƒ½æè¿°"
              onChange={(e) => onUpdate({...adjustment, description: e.target.value})}
            />
            <label>
              <input type="checkbox" />
              æ ¸å¿ƒåŠŸèƒ½
            </label>
          </div>
        )}
      </div>

      <button
        onClick={() => onUpdate({...adjustment, newValue: editValue})}
        className="apply-adjustment"
      >
        åº”ç”¨
      </button>
    </div>
  )
}

// å·¥å…·å‡½æ•°
const getComplexityLabel = (level: string): string => {
  const labels = {
    'simple': 'ç®€å•',
    'moderate': 'ä¸­ç­‰',
    'complex': 'å¤æ‚'
  }
  return labels[level] || level
}

const getAdjustmentTypeLabel = (type: string): string => {
  const labels = {
    'goal': 'ä¿®æ”¹ç›®æ ‡',
    'users': 'ä¿®æ”¹ç”¨æˆ·',
    'modify_feature': 'ä¿®æ”¹åŠŸèƒ½',
    'add_feature': 'æ·»åŠ åŠŸèƒ½',
    'remove_feature': 'åˆ é™¤åŠŸèƒ½'
  }
  return labels[type] || type
}
```

### è°ƒæ•´è¯·æ±‚å¤„ç†

```typescript
interface AdjustmentRequest {
  type: 'goal' | 'users' | 'modify_feature' | 'add_feature' | 'remove_feature';
  currentValue?: any;
  newValue?: any;
  featureIndex?: number;
}

class RequirementAdjustmentProcessor {
  async processAdjustments(
    summary: RequirementSummary,
    adjustments: AdjustmentRequest[]
  ): Promise<RequirementSummary> {
    let adjustedSummary = { ...summary }

    for (const adjustment of adjustments) {
      switch (adjustment.type) {
        case 'goal':
          adjustedSummary.coreGoal = adjustment.newValue
          break

        case 'users':
          adjustedSummary.targetUsers = adjustment.newValue
          break

        case 'modify_feature':
          if (adjustment.featureIndex !== undefined) {
            adjustedSummary.mainFeatures[adjustment.featureIndex] = {
              ...adjustedSummary.mainFeatures[adjustment.featureIndex],
              ...adjustment.newValue
            }
          }
          break

        case 'add_feature':
          adjustedSummary.mainFeatures.push({
            name: adjustment.newValue.name,
            description: adjustment.newValue.description,
            essential: adjustment.newValue.essential || false,
            source: 'user_confirmed'
          })
          break

        case 'remove_feature':
          if (adjustment.featureIndex !== undefined) {
            adjustedSummary.mainFeatures.splice(adjustment.featureIndex, 1)
          }
          break
      }
    }

    // é‡æ–°éªŒè¯è°ƒæ•´åçš„æ€»ç»“
    const validation = this.summaryGenerator.validateSummaryQuality(adjustedSummary)
    if (!validation.isValid) {
      throw new Error(`è°ƒæ•´åçš„éœ€æ±‚æ€»ç»“å­˜åœ¨é—®é¢˜ï¼š${validation.issues.join(', ')}`)
    }

    return adjustedSummary
  }
}
```

## ğŸ“Š åŒé‡è¾“å‡ºç»“æœ

### è¾“å‡º1ï¼šç”¨æˆ·ç¡®è®¤ç•Œé¢å±•ç¤º

```typescript
// ç”¨æˆ·ç¡®è®¤ç•Œé¢çš„ç®€æ´éœ€æ±‚æ€»ç»“
interface RequirementSummary {
  projectName: string;           // "é‚®ç®±æå–æ’ä»¶"
  coreGoal: string;             // "è‡ªåŠ¨æå–ç½‘é¡µé‚®ç®±ï¼Œæé«˜æ•ˆç‡"
  targetUsers: string;          // "ä¸ªäººç”¨æˆ·"
  mainFeatures: Feature[];      // 3-5ä¸ªæ ¸å¿ƒåŠŸèƒ½ï¼Œç®€æ´å±•ç¤º
  technicalLevel: 'simple' | 'moderate' | 'complex';
  keyConstraints?: string[];    // å…³é”®çº¦æŸï¼ˆå¦‚æœ‰ï¼‰
  userScope: 'personal' | 'small_team' | 'public';
}

interface Feature {
  name: string;                 // "è‡ªåŠ¨è¯†åˆ«é‚®ç®±"
  description: string;          // "æ‰«æç½‘é¡µä¸­çš„é‚®ç®±åœ°å€"
  essential: boolean;           // æ˜¯å¦ä¸ºæ ¸å¿ƒåŠŸèƒ½
  source: 'user_input' | 'ai_inferred' | 'user_confirmed';
}
```

### è¾“å‡º2ï¼šä¼ é€’ç»™04æ¨¡å—çš„è¯¦ç»†äº‹å®æ‘˜è¦

```typescript
// PRDç”Ÿæˆå™¨éœ€è¦çš„å®Œæ•´æŠ€æœ¯è¾“å…¥ï¼ˆåŒ¹é…04æ¨¡å—æ¥å£ï¼‰
interface FactsDigest {
  productDefinition: {
    type: string;                     // "browser_extension"
    coreGoal: string;                // "è‡ªåŠ¨æå–ç½‘é¡µä¸­çš„é‚®ç®±åœ°å€ï¼Œæé«˜æ”¶é›†æ•ˆç‡"
    targetUsers: string;             // "ç»å¸¸éœ€è¦æ”¶é›†å®¢æˆ·é‚®ç®±çš„ä¸ªäººç”¨æˆ·"
    userScope: string;               // "personal"
  };

  functionalRequirements: {
    coreFeatures: string[];          // ["è‡ªåŠ¨è¯†åˆ«ç½‘é¡µé‚®ç®±", "ä¸€é”®æå–åŠŸèƒ½"]
    useScenarios: string[];          // ["æ”¶é›†å®¢æˆ·é‚®ç®±", "æ‰¹é‡è”ç³»äººæ•´ç†"]
    userJourney: string;             // "æ‰“å¼€ç½‘é¡µ â†’ ç‚¹å‡»æ’ä»¶å›¾æ ‡ â†’ è‡ªåŠ¨æ‰«æè¯†åˆ«..."
  };

  constraints: {
    technicalLevel: string;          // "simple"
    keyLimitations: string[];        // ["æµè§ˆå™¨æƒé™é™åˆ¶", "è·¨åŸŸè®¿é—®é™åˆ¶"]
    platformPreference?: string;     // å¹³å°åå¥½ï¼ˆå¯é€‰ï¼‰
  };

  contextualInfo: {
    painPoints: string[];            // ["æ‰‹åŠ¨å¤åˆ¶ç²˜è´´å¾ˆéº»çƒ¦"]
    currentSolutions: string[];      // ["æ‰‹åŠ¨æŸ¥æ‰¾å’Œå¤åˆ¶é‚®ç®±åœ°å€"]
    businessValue?: string;          // "æé«˜å·¥ä½œæ•ˆç‡ï¼Œå‡å°‘é‡å¤åŠ³åŠ¨"
    performanceRequirements?: string; // "å¿«é€Ÿå“åº”ï¼Œå†…å­˜å ç”¨<10MB"
    dataHandling?: string;           // "ä¿å­˜æå–ç»“æœåˆ°æœ¬åœ°Excelæˆ–CSVæ–‡ä»¶"
    securityConsiderations?: string[]; // ["ä¸æ”¶é›†ç”¨æˆ·æ•°æ®", "æœ¬åœ°å¤„ç†"]
  };
}

```

### äº‹å®æ‘˜è¦ç”Ÿæˆå™¨

```typescript
class FactsDigestGenerator {
  generateFactsDigest(
    confirmedSummary: RequirementSummary,
    originalExtractedInfo: ExtractedInfo,
    questioningSession: QuestioningSession
  ): FactsDigest {
    return {
      productDefinition: {
        type: this.inferProductType(confirmedSummary, originalExtractedInfo),
        coreGoal: confirmedSummary.coreGoal,
        targetUsers: confirmedSummary.targetUsers,
        userScope: confirmedSummary.userScope
      },

      functionalRequirements: {
        coreFeatures: confirmedSummary.mainFeatures.map(f => f.name),
        useScenarios: [originalExtractedInfo.useScenario].filter(Boolean),
        userJourney: originalExtractedInfo.userJourney || this.constructUserJourney(confirmedSummary)
      },

      constraints: {
        technicalLevel: confirmedSummary.technicalLevel,
        keyLimitations: confirmedSummary.keyConstraints || [],
        platformPreference: this.inferPlatformPreference(originalExtractedInfo.technicalHints)
      },

      contextualInfo: {
        painPoints: [originalExtractedInfo.painPoint].filter(Boolean),
        currentSolutions: [originalExtractedInfo.currentSolution].filter(Boolean),
        businessValue: this.inferBusinessValue(originalExtractedInfo.painPoint),
        performanceRequirements: originalExtractedInfo.performanceRequirements,
        dataHandling: originalExtractedInfo.dataHandling,
        securityConsiderations: this.inferSecurityRequirements(confirmedSummary.userScope)
      }
    };
  }

  private inferPlatformPreference(technicalHints: string[]): string {
    if (!technicalHints || technicalHints.length === 0) return "è·¨å¹³å°";

    const hints = technicalHints.join(' ').toLowerCase();

    if (hints.includes('chrome') || hints.includes('firefox') || hints.includes('extension')) {
      return "æµè§ˆå™¨æ’ä»¶";
    }
    if (hints.includes('web') || hints.includes('html') || hints.includes('javascript')) {
      return "Webåº”ç”¨";
    }
    if (hints.includes('desktop') || hints.includes('electron')) {
      return "æ¡Œé¢åº”ç”¨";
    }
    if (hints.includes('mobile') || hints.includes('app')) {
      return "ç§»åŠ¨åº”ç”¨";
    }

    return "è·¨å¹³å°";
  }

  private inferBusinessValue(painPoint: string): string {
    if (!painPoint) return "æå‡ç”¨æˆ·ä½“éªŒå’Œå·¥ä½œæ•ˆç‡";

    if (painPoint.includes('æ‰‹åŠ¨') || painPoint.includes('éº»çƒ¦')) {
      return "è‡ªåŠ¨åŒ–å¤„ç†ï¼Œå¤§å¹…æé«˜å·¥ä½œæ•ˆç‡ï¼Œå‡å°‘é‡å¤åŠ³åŠ¨";
    }
    if (painPoint.includes('åˆ†æ•£') || painPoint.includes('æ‰¾ä¸åˆ°')) {
      return "ç»Ÿä¸€ç®¡ç†ï¼Œä¾¿äºæŸ¥æ‰¾å’Œä½¿ç”¨ï¼Œæå‡ç»„ç»‡æ•ˆç‡";
    }
    if (painPoint.includes('åä½œ') || painPoint.includes('æ²Ÿé€š')) {
      return "æ”¹å–„åä½œä½“éªŒï¼Œæå‡å›¢é˜Ÿå·¥ä½œæ•ˆç‡";
    }

    return "è§£å†³ç”¨æˆ·ç—›ç‚¹ï¼Œæå‡ä½¿ç”¨ä½“éªŒå’Œå·¥ä½œæ•ˆç‡";
  }

  private constructUserJourney(summary: RequirementSummary): string {
    // åŸºäºåŠŸèƒ½æ„å»ºåŸºæœ¬ç”¨æˆ·æµç¨‹
    const steps = summary.mainFeatures
      .filter(f => f.essential)
      .map(f => this.featureToStep(f.name))
      .join(' â†’ ');

    return steps || 'æ‰“å¼€å·¥å…· â†’ æ‰§è¡Œæ“ä½œ â†’ è·å¾—ç»“æœ';
  }

  private featureToStep(featureName: string): string {
    const stepMappings = {
      'è¯†åˆ«': 'æ™ºèƒ½è¯†åˆ«',
      'æå–': 'ä¸€é”®æå–',
      'ä¿å­˜': 'ä¿å­˜ç»“æœ',
      'å¯¼å‡º': 'å¯¼å‡ºæ•°æ®',
      'ç®¡ç†': 'ç®¡ç†å†…å®¹',
      'åˆ†æ': 'åˆ†æå¤„ç†'
    };

    for (const [key, step] of Object.entries(stepMappings)) {
      if (featureName.includes(key)) {
        return step;
      }
    }

    return featureName;
  }

  private inferSecurityRequirements(userScope: string): string[] {
    const baseRequirements = ["æ•°æ®å®‰å…¨ä¿æŠ¤", "ç”¨æˆ·éšç§ä¿æŠ¤"];

    if (userScope === 'personal') {
      return [...baseRequirements, "æœ¬åœ°æ•°æ®å¤„ç†", "ç”¨æˆ·å®Œå…¨æ§åˆ¶"];
    }
    if (userScope === 'small_team') {
      return [...baseRequirements, "å›¢é˜Ÿæ•°æ®å…±äº«å®‰å…¨", "è®¿é—®æƒé™æ§åˆ¶"];
    }
    if (userScope === 'public') {
      return [...baseRequirements, "å¤§è§„æ¨¡ç”¨æˆ·æ•°æ®ä¿æŠ¤", "åˆè§„æ€§è¦æ±‚"];
    }

    return baseRequirements;
  }

  private inferProductType(summary: RequirementSummary, extractedInfo: ExtractedInfo): string {
    if (extractedInfo.productType) return extractedInfo.productType;

    const goal = summary.coreGoal.toLowerCase();
    const features = summary.mainFeatures.map(f => f.name.toLowerCase()).join(' ');

    if (goal.includes('æ’ä»¶') || features.includes('æµè§ˆå™¨')) {
      return 'browser_extension';
    }
    if (goal.includes('ç®¡ç†') || features.includes('ç®¡ç†')) {
      return 'management_tool';
    }
    if (goal.includes('ç½‘ç«™') || goal.includes('åº”ç”¨') || goal.includes('å¹³å°')) {
      return 'web_app';
    }

    return 'utility_tool';
  }
}
```

## ğŸ”„ æ§åˆ¶å™¨

```typescript
class RequirementConfirmationController {
  private summaryGenerator: RequirementSummaryGenerator;
  private adjustmentProcessor: RequirementAdjustmentProcessor;
  private factsDigestGenerator: FactsDigestGenerator;

  async processQuestioningResult(
    questioningResult: SmartQuestioningResult
  ): Promise<RequirementConfirmationState> {
    // 1. ç”Ÿæˆç”¨æˆ·å‹å¥½çš„éœ€æ±‚æ€»ç»“ï¼ˆç»™ç”¨æˆ·ç¡®è®¤ç•Œé¢ç”¨ï¼‰
    const summary = await this.summaryGenerator.generateSummary(
      questioningResult.extractedInfo,
      questioningResult.questioningSession.answers,
      questioningResult.userInputResult
    )

    // 2. éªŒè¯æ€»ç»“è´¨é‡
    const validation = this.summaryGenerator.validateSummaryQuality(summary)

    return {
      summary,
      validation,
      state: 'awaiting_confirmation',
      originalQuestioningResult: questioningResult
    }
  }

  async handleUserConfirmation(
    confirmationState: RequirementConfirmationState,
    userAction: 'confirm' | 'adjust' | 'restart',
    adjustments?: AdjustmentRequest[]
  ): Promise<RequirementConfirmationResult> {
    switch (userAction) {
      case 'confirm':
        return this.finalizeRequirements(confirmationState)

      case 'adjust':
        if (!adjustments) {
          throw new Error('Adjustments required for adjust action')
        }
        return this.processAdjustments(confirmationState, adjustments)

      case 'restart':
        return {
          action: 'restart_questioning',
          message: 'å°†é‡æ–°å¼€å§‹éœ€æ±‚é—®ç­”æµç¨‹'
        }

      default:
        throw new Error(`Unknown user action: ${userAction}`)
    }
  }

  private async finalizeRequirements(
    confirmationState: RequirementConfirmationState
  ): Promise<RequirementConfirmationResult> {
    // ç”¨æˆ·ç¡®è®¤äº†ç®€åŒ–çš„éœ€æ±‚æ€»ç»“ï¼Œç°åœ¨ç”Ÿæˆäº‹å®æ‘˜è¦ç»™04æ¨¡å—
    const factsDigest = this.factsDigestGenerator.generateFactsDigest(
      confirmationState.summary,  // ç”¨æˆ·ç¡®è®¤çš„ç®€åŒ–æ€»ç»“
      confirmationState.originalQuestioningResult.extractedInfo,  // åŸå§‹æå–ä¿¡æ¯
      confirmationState.originalQuestioningResult.questioningSession  // é—®ç­”ä¼šè¯è®°å½•
    )

    return {
      action: 'proceed_to_prd',
      // ä¼ é€’ç»™04æ¨¡å—çš„äº‹å®æ‘˜è¦
      factsDigest,
      // ç”¨æˆ·ç¡®è®¤çš„ç®€åŒ–éœ€æ±‚æ€»ç»“ï¼ˆä¾›è®°å½•å’Œå‚è€ƒï¼‰
      confirmedSummary: confirmationState.summary,
      validation: {
        confirmed: true,
        confidence: 0.95,
        timestamp: new Date()
      }
    }
  }

  private async processAdjustments(
    confirmationState: RequirementConfirmationState,
    adjustments: AdjustmentRequest[]
  ): Promise<RequirementConfirmationResult> {
    try {
      const adjustedSummary = await this.adjustmentProcessor.processAdjustments(
        confirmationState.summary,
        adjustments
      )

      return {
        action: 'show_adjusted_summary',
        adjustedSummary,
        validation: this.summaryGenerator.validateSummaryQuality(adjustedSummary)
      }
    } catch (error) {
      return {
        action: 'adjustment_error',
        error: error.message
      }
    }
  }
}

interface RequirementConfirmationState {
  summary: RequirementSummary;
  validation: ValidationResult;
  state: 'awaiting_confirmation' | 'processing_adjustments';
  originalQuestioningResult: SmartQuestioningResult;
}
```

## è¾“å‡ºæ¥å£

```typescript
interface RequirementConfirmationResult {
  action: 'proceed_to_prd' | 'show_adjusted_summary' | 'restart_questioning' | 'adjustment_error';

  // ä¼ é€’ç»™04æ¨¡å—çš„äº‹å®æ‘˜è¦
  factsDigest?: FactsDigest;

  // ç”¨æˆ·ç¡®è®¤çš„ç®€åŒ–éœ€æ±‚æ€»ç»“ï¼ˆä¾›è®°å½•ï¼‰
  confirmedSummary?: RequirementSummary;

  // å¦‚æœæ˜¯è°ƒæ•´ï¼Œè¿”å›è°ƒæ•´åçš„å±•ç¤ºæ€»ç»“
  adjustedSummary?: RequirementSummary;

  validation?: {
    confirmed: boolean;
    confidence: number;
    timestamp: Date;
  };

  error?: string;
  message?: string;
}

// ç”¨æˆ·ç¡®è®¤ç•Œé¢å±•ç¤ºçš„ç®€åŒ–æ¥å£
interface RequirementSummary {
  projectName: string;
  coreGoal: string;
  targetUsers: string;
  mainFeatures: Feature[];
  technicalLevel: 'simple' | 'moderate' | 'complex';
  keyConstraints?: string[];
  userScope: 'personal' | 'small_team' | 'public';
}
```

## ä¸å…¶ä»–æ¨¡å—çš„æ¥å£

### è¾“å…¥ï¼šæ¥è‡ªæ™ºèƒ½é—®ç­”æ¨¡å—ï¼ˆ02æ¨¡å—ï¼‰
- `SmartQuestioningResult`ï¼šåŒ…å«ExtractedInfoã€é—®ç­”ä¼šè¯è®°å½•ã€å®Œæ•´åº¦è¯„ä¼°ç­‰å®Œæ•´æ•°æ®

### è¾“å‡ºï¼šä¼ é€’ç»™PRDç”Ÿæˆæ¨¡å—ï¼ˆ04æ¨¡å—ï¼‰
- **ä¸»è¦è¾“å‡º**ï¼š`FactsDigest` - ç»“æ„åŒ–çš„éœ€æ±‚äº‹å®æ‘˜è¦ï¼ŒåŒ…å«ï¼š
  - äº§å“å®šä¹‰ï¼ˆç±»å‹ã€ç›®æ ‡ã€ç”¨æˆ·ï¼‰
  - åŠŸèƒ½éœ€æ±‚ï¼ˆæ ¸å¿ƒåŠŸèƒ½ã€ä½¿ç”¨åœºæ™¯ã€ç”¨æˆ·æµç¨‹ï¼‰
  - çº¦æŸæ¡ä»¶ï¼ˆæŠ€æœ¯æ°´å¹³ã€é™åˆ¶ã€å¹³å°åå¥½ï¼‰
  - ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼ˆç—›ç‚¹ã€è§£å†³æ–¹æ¡ˆã€å•†ä¸šä»·å€¼ã€æ€§èƒ½è¦æ±‚ç­‰ï¼‰

- **è¾…åŠ©è¾“å‡º**ï¼š`RequirementSummary` - ç”¨æˆ·ç¡®è®¤çš„ç®€åŒ–éœ€æ±‚æ€»ç»“ï¼ˆä¾›è®°å½•å’Œå‚è€ƒï¼‰

### å…³é”®è®¾è®¡ç‰¹ç‚¹

âœ… **04æ¨¡å—å‹åŠ›å‡è½»**ï¼šæ¥æ”¶ç»“æ„åŒ–å®Œæ•´è¾“å…¥ï¼Œä¸“æ³¨PRDç”Ÿæˆå’Œæµå¼è¾“å‡º
âœ… **èŒè´£æ¸…æ™°**ï¼š03æ¨¡å—è´Ÿè´£æ•°æ®è½¬æ¢ï¼Œ04æ¨¡å—è´Ÿè´£æ–‡æ¡£ç”Ÿæˆ
âœ… **ç”¨æˆ·ä½“éªŒ**ï¼šç”¨æˆ·çœ‹åˆ°ç®€æ´çš„ç¡®è®¤ç•Œé¢ï¼ŒæŠ€æœ¯ç»†èŠ‚åœ¨åå°å¤„ç†
âœ… **æ¥å£åŒ¹é…**ï¼šç”¨æˆ·ç¡®è®¤çš„RequirementSummary â‰  04æ¨¡å—æ¥æ”¶çš„FactsDigestï¼ŒèŒè´£åˆ†ç¦»æ¸…æ™°

## å…³é”®ç‰¹æ€§

### âœ… **ç®€æ´æ˜äº†çš„éœ€æ±‚å±•ç¤º**
- é¿å…æŠ€æœ¯æœ¯è¯­ï¼Œç”¨ç”¨æˆ·å®¹æ˜“ç†è§£çš„è¯­è¨€
- çªå‡ºæ ¸å¿ƒåŠŸèƒ½ï¼Œæ˜ç¡®ä¼˜å…ˆçº§
- æ¸…æ™°çš„è§†è§‰å±‚æ¬¡å’Œäº¤äº’åé¦ˆ

### âœ… **çµæ´»çš„è°ƒæ•´æœºåˆ¶**
- æ”¯æŒå¿«é€Ÿä¿®æ”¹ç›®æ ‡ã€ç”¨æˆ·ã€åŠŸèƒ½
- æ”¯æŒæ·»åŠ æˆ–åˆ é™¤åŠŸèƒ½
- å®æ—¶éªŒè¯è°ƒæ•´ç»“æœçš„åˆç†æ€§

### âœ… **è´¨é‡ä¿è¯**
- è‡ªåŠ¨éªŒè¯éœ€æ±‚æ€»ç»“çš„å®Œæ•´æ€§å’Œåˆç†æ€§
- æä¾›æ”¹è¿›å»ºè®®
- ç¡®ä¿åç»­PRDç”Ÿæˆçš„è´¨é‡
