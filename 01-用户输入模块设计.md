# 用户输入模块设计

## 模块概述

用户输入模块是整个AI产品经理工具的入口，负责接收和处理用户的需求描述，支持文本和图片的多模态输入，通过AI进行基础分析整合，为后续的智能问答模块提供完整的需求上下文。

## 核心功能

### 1. 多模态输入支持

#### 1.1 文本输入
```typescript
interface TextInput {
  content: string;
  timestamp: Date;
  wordCount: number;
}

const TextInputComponent = () => {
  return (
    <div className="text-input-container">
      <textarea
        placeholder="描述您想要实现的产品或功能，越详细越好..."
        className="requirement-textarea"
        maxLength={2000}
        rows={8}
      />
      <div className="input-helper">
        <span className="word-count">{wordCount}/2000</span>
        <div className="example-prompts">
          <p>💡 例如：</p>
          <button onClick={fillExample1}>
            "我想做一个浏览器插件，自动提取网页邮箱..."
          </button>
          <button onClick={fillExample2}>
            "需要一个团队任务管理工具，能看到进度..."
          </button>
        </div>
      </div>
    </div>
  );
};
```

#### 1.2 图片输入处理
```typescript
interface ImageInput {
  id: string;
  file: File;
  preview: string;
}

// 图片处理组件
const ImageInputComponent = () => {
  const [images, setImages] = useState<ImageInput[]>([]);

  const handleImageUpload = async (files: FileList) => {
    for (const file of files) {
      if (file.size > 10 * 1024 * 1024) { // 10MB限制
        toast.error('图片大小不能超过10MB');
        continue;
      }

      const imageInput: ImageInput = {
        id: generateId(),
        file,
        preview: URL.createObjectURL(file)
      };

      setImages(prev => [...prev, imageInput]);
    }
  };

  return (
    <div className="image-input-section">
      <div className="upload-area" {...getRootProps()}>
        <input {...getInputProps()} accept="image/*" multiple max={5} />
        <div className="upload-content">
          <FiUpload size={24} />
          <p>拖拽图片到这里，或点击上传</p>
          <p className="upload-hint">支持UI草图、流程图、截图等（最多5张）</p>
        </div>
      </div>

      <div className="image-preview-list">
        {images.map(image => (
          <ImagePreview
            key={image.id}
            image={image}
            onRemove={() => removeImage(image.id)}
          />
        ))}
      </div>
    </div>
  );
};
```

### 2. 多模态内容分析

```typescript
interface MultimodalAnalysis {
  textSummary: string;           // 文本内容摘要
  imageDescriptions: string[];   // 图片内容描述
  extractedText: string[];       // 图片中提取的文字
  combinedContext: string;       // 文本+图片的综合需求描述
  confidence: number;            // 分析置信度
}

class MultimodalAnalyzer {
  async analyzeUserInput(
    textInput: string,
    images: File[]
  ): Promise<MultimodalAnalysis> {

    if (images.length === 0) {
      // 纯文本情况
      return {
        textSummary: textInput,
        imageDescriptions: [],
        extractedText: [],
        combinedContext: textInput,
        confidence: 1.0
      };
    }

    const prompt = `
      用户想要开发一个产品，提供了以下信息：

      文字描述：${textInput}

      另外还上传了${images.length}张图片，请分析这些图片内容：
      1. 描述图片中的内容（UI界面、流程图、草图等）
      2. 提取图片中的文字信息
      3. 结合文字描述，形成完整统一的需求描述

      请返回JSON格式：
      {
        "textSummary": "文字描述的简洁总结",
        "imageDescriptions": ["图片1的详细描述", "图片2的详细描述"],
        "extractedText": ["图片1中的文字", "图片2中的文字"],
        "combinedContext": "结合文字和图片的完整需求描述，保持用户原意",
        "confidence": 0.95
      }
    `;

    try {
      // 调用多模态API进行分析
      const result = await this.multimodalAPI.analyze({
        text: prompt,
        images: images.map(img => this.imageToBase64(img))
      });

      return JSON.parse(result);
    } catch (error) {
      console.error('多模态分析失败:', error);
      // 降级处理：只返回文本内容
      return {
        textSummary: textInput,
        imageDescriptions: images.map((_, index) => `图片${index + 1}（分析失败）`),
        extractedText: [],
        combinedContext: textInput + '

注：图片分析失败，请在后续问答中补充相关信息。',
        confidence: 0.5
      };
    }
  }

  private imageToBase64(file: File): Promise<string> {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result as string);
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  }
}
```

### 3. 基础输入验证

```typescript
interface BasicValidation {
  isValid: boolean;
  hasContent: boolean;
  wordCount: number;
  issues: string[];
}

class BasicInputValidator {
  validate(textInput: string, images: File[]): BasicValidation {
    const issues: string[] = [];

    // 内容检查
    const hasTextContent = textInput && textInput.trim().length >= 10;
    const hasImageContent = images && images.length > 0;

    if (!hasTextContent && !hasImageContent) {
      issues.push('请描述您的产品想法或上传相关图片');
    }

    // 文本长度检查
    if (textInput && textInput.length > 2000) {
      issues.push('文字描述请控制在2000字以内');
    }

    if (textInput && textInput.trim().length < 10 && images.length === 0) {
      issues.push('文字描述过短，请提供更多细节或上传相关图片');
    }

    // 图片检查
    if (images.length > 5) {
      issues.push('最多上传5张图片');
    }

    for (const image of images) {
      if (image.size > 10 * 1024 * 1024) {
        issues.push(`图片 ${image.name} 过大，请控制在10MB以内`);
      }

      if (!image.type.startsWith('image/')) {
        issues.push(`${image.name} 不是有效的图片文件`);
      }
    }

    return {
      isValid: issues.length === 0,
      hasContent: hasTextContent || hasImageContent,
      wordCount: textInput?.length || 0,
      issues
    };
  }
}
```

## 用户界面设计

### 主输入界面
```tsx
const UserInputModule = () => {
  const [textInput, setTextInput] = useState('');
  const [images, setImages] = useState<File[]>([]);
  const [analysis, setAnalysis] = useState<MultimodalAnalysis | null>(null);
  const [validation, setValidation] = useState<BasicValidation | null>(null);
  const [isAnalyzing, setIsAnalyzing] = useState(false);

  const handleInputChange = async (text: string, imageFiles: File[]) => {
    setTextInput(text);
    setImages(imageFiles);

    // 基础验证
    const basicValidation = validator.validate(text, imageFiles);
    setValidation(basicValidation);

    // 如果有效且有内容，进行多模态分析
    if (basicValidation.isValid && basicValidation.hasContent) {
      setIsAnalyzing(true);
      try {
        const analysisResult = await multimodalAnalyzer.analyzeUserInput(text, imageFiles);
        setAnalysis(analysisResult);
      } catch (error) {
        console.error('多模态分析失败:', error);
      } finally {
        setIsAnalyzing(false);
      }
    } else {
      setAnalysis(null);
    }
  };

  const handleSubmit = async () => {
    if (!validation?.isValid || !analysis) return;

    const result: UserInputResult = {
      originalInput: {
        text: textInput,
        images: images,
        timestamp: new Date()
      },
      multimodalAnalysis: analysis,
      validation: validation
    };

    // 进入智能问答模块
    onNextStep(result);
  };

  return (
    <div className="user-input-module">
      <div className="input-header">
        <h1>🎯 描述您的产品想法</h1>
        <p>详细描述您想要实现的产品功能，也可以上传相关的界面草图、流程图等</p>
      </div>

      {/* 文本输入区域 */}
      <div className="text-input-section">
        <textarea
          value={textInput}
          onChange={(e) => handleInputChange(e.target.value, images)}
          placeholder="描述您想要实现的产品或功能，例如：我想做一个浏览器插件，可以自动提取网页中的邮箱地址..."
          className="input-textarea"
          rows={6}
          maxLength={2000}
        />
        <div className="input-meta">
          <span className="word-count">{textInput.length}/2000</span>
        </div>
      </div>

      {/* 图片上传区域 */}
      <div className="image-input-section">
        <h3>📎 上传相关图片（可选）</h3>
        <p className="hint">UI草图、流程图、参考截图等，有助于更好地理解您的需求</p>

        <input
          type="file"
          accept="image/*"
          multiple
          onChange={(e) => {
            const files = Array.from(e.target.files || []);
            handleInputChange(textInput, files);
          }}
          className="image-input"
        />

        {images.length > 0 && (
          <div className="image-preview">
            {images.map((image, index) => (
              <div key={index} className="image-item">
                <img
                  src={URL.createObjectURL(image)}
                  alt={`上传图片${index + 1}`}
                  className="preview-image"
                />
                <span className="image-name">{image.name}</span>
                <button
                  onClick={() => {
                    const newImages = images.filter((_, i) => i !== index);
                    handleInputChange(textInput, newImages);
                  }}
                  className="remove-image"
                >
                  ×
                </button>
              </div>
            ))}
          </div>
        )}
      </div>

      {/* 多模态分析状态 */}
      {isAnalyzing && (
        <div className="analysis-loading">
          <div className="loading-spinner"></div>
          <p>🔍 正在分析您的输入内容...</p>
        </div>
      )}

      {/* 分析结果预览 */}
      {analysis && (
        <div className="analysis-preview">
          <h4>📋 需求理解预览</h4>
          <div className="combined-context">
            <p>{analysis.combinedContext}</p>
            <span className="confidence">置信度: {(analysis.confidence * 100).toFixed(0)}%</span>
          </div>

          {analysis.imageDescriptions.length > 0 && (
            <details className="image-analysis">
              <summary>查看图片分析详情</summary>
              <div className="image-details">
                {analysis.imageDescriptions.map((desc, index) => (
                  <div key={index} className="image-detail">
                    <strong>图片{index + 1}:</strong> {desc}
                    {analysis.extractedText[index] && (
                      <div className="extracted-text">
                        <em>提取的文字:</em> {analysis.extractedText[index]}
                      </div>
                    )}
                  </div>
                ))}
              </div>
            </details>
          )}
        </div>
      )}

      {/* 验证反馈 */}
      {validation && !validation.isValid && (
        <div className="validation-feedback">
          {validation.issues.map((issue, index) => (
            <p key={index} className="validation-issue">⚠️ {issue}</p>
          ))}
        </div>
      )}

      {/* 提交按钮 */}
      <div className="submit-section">
        <button
          onClick={handleSubmit}
          disabled={!validation?.isValid || isAnalyzing || !analysis}
          className="next-step-button"
        >
          {isAnalyzing ? '分析中...' : '开始智能问答 →'}
        </button>

        {analysis && analysis.confidence < 0.7 && (
          <p className="low-confidence-hint">
            💡 内容分析置信度较低，建议补充更详细的描述
          </p>
        )}
      </div>
    </div>
  );
};
```

### 输出接口

```typescript
interface UserInputResult {
  // 原始输入内容
  originalInput: {
    text: string;
    images: File[];
    timestamp: Date;
  };

  // 多模态分析结果
  multimodalAnalysis: {
    textSummary: string;           // 文本摘要
    imageDescriptions: string[];   // 图片描述
    extractedText: string[];       // 图片中的文字
    combinedContext: string;       // 综合需求描述
    confidence: number;            // 分析置信度
  };

  // 验证结果
  validation: {
    isValid: boolean;
    hasContent: boolean;
    wordCount: number;
    issues: string[];
  };
}
```

## 关键特性

### ✅ 多模态输入支持
- 文本输入：支持详细需求描述（最多2000字）
- 图片输入：UI草图、流程图、产品截图等（最多5张，每张最多10MB）

### ✅ 智能内容整合
- 利用多模态AI分析文本和图片内容
- 提取图片中的文字信息
- 生成统一的需求上下文描述

### ✅ 基础质量保证
- 输入内容验证（长度、格式、文件大小）
- 多模态分析置信度评估
- 友好的错误提示和建议

### ✅ 用户体验友好
- 实时预览分析结果
- 直观的图片上传和管理
- 清晰的进度反馈

## 与后续模块的接口

用户输入模块处理完成后，将 `UserInputResult` 传递给**智能问答模块（02模块）**，提供：

1. **原始输入**：保留用户的原始文本和图片，供参考和回溯
2. **多模态分析**：综合的需求上下文，减少02模块的重复分析工作
3. **质量信息**：输入质量和分析置信度，帮助02模块调整问答策略

**职责边界**：
- **01模块**：负责输入收集和基础整合，不做智能推理和产品分析
- **02模块**：基于01模块的输出进行深度的需求分析和智能问答
